name: Generate rich-codex example images
on: [push]

env:
  TERMINAL_WIDTH: 120
  FORCE_COLOR: true
  LOG_SAVE: true

jobs:
  rich_codex:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - name: Install requirements
        run: pip install cowsay lolcat .

      - name: Delete all existing images
        run: |
          rm -r examples/*/img/
          rm -r docs/img

      - name: Generate images from markdown comments
        run: rich-codex

      - name: Generate images from action command
        run: rich-codex
        env:
          NO_SEARCH: true
          COMMAND: cowsay "Taste the rainbow" | lolcat --force -S 100
          IMG_PATHS: |
            examples/actions/cowsay-colours.svg
            examples/actions/cowsay-colours.png
            examples/actions/cowsay-colours.pdf

      - name: Generate images from action snippet
        run: rich-codex
        env:
          NO_SEARCH: true
          SNIPPET: |
            >>> print("[italic red]Hello[/italic red] World!", locals())
            Hello World!
            {
                '__annotations__': {},
                '__builtins__': <module 'builtins' (built-in)>,
                '__doc__': None,
                '__loader__': <class '_frozen_importlib.BuiltinImporter'>,
                '__name__': '__main__',
                '__package__': None,
                '__spec__': None,
                'print': <function print at 0x1027fd4c0>,
            }
          IMG_PATHS: |
            examples/actions/rich-example.svg
            examples/actions/rich-example.png

      - name: Generate images from a YAML config
        run: rich-codex
        env:
          NO_SEARCH: true
          RC_CONFIGS: examples/yml_configs/*.yml

      - name: Add and commit new images
        run: |
          git config --local user.name 'github-actions[bot]'
          git config --local user.email 'github-actions[bot]@users.noreply.github.com'
          git status
          if [[ `git status --porcelain` ]]; then
            git add . && git commit -m "Generate new screengrabs with rich-codex"
            git push
          fi

      - name: Upload sync log file artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: Log files
          path: rich_codex_*.log
